<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSS :target Fade Effect (JS Conditional + Click Away)</title>
    <style>
        /* --- CSS rules remain EXACTLY the same --- */

        html { scroll-behavior: smooth; }
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding: 0 20px; }
        nav { background-color: #f4f4f4; padding: 10px 0; text-align: center; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #ccc; }
        nav a { margin: 0 15px; text-decoration: none; color: #333; font-weight: bold; }
        nav a:hover { color: #007bff; }
        main { padding: 20px 0; }

        /* Base style for sections */
        main > section {
            padding: 40px 20px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; min-height: 100px;
            opacity: 1; /* Default: visible */
            transition: opacity 0.6s ease-in-out, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Conditional Fading Styles */
        main.has-target > section {
            opacity: 0.25; border-color: #ddd; box-shadow: none;
        }
        main.has-target > section:target {
            opacity: 1; border-color: #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
        }
        /* End Conditional Fading Styles */

        h2 { margin-top: 0; color: #333; }
        main.has-target > section:target h2 { color: #0056b3; }

        #top-anchor { display: block; height: 1px; }

    </style>
</head>
<body>
    <span id="top-anchor"></span>

    <nav>
        <a href="#top-anchor">Go To Top (No Fade)</a> |
        <a href="#book-intro">Book Intro (Fade)</a>
        <a href="#book-chapter1">Chapter 1 (Fade)</a>
        <a href="#other-notes">Other Notes (No Fade)</a>
        <a href="#book-summary">Summary (Fade)</a> |
        <a href="#">Clear Target (No Fade)</a>
    </nav>

    <main>
        <section id="intro-notes">
            <h2>Introductory Notes</h2>
            <p>Click a "Book" link below to activate the fade effect.</p>
            <p>Then, try clicking anywhere else on the page (like this text, or the empty background) - the fade effect should disappear.</p>
        </section>

        <section id="book-intro">
            <h2>Book Introduction</h2>
            <p>This section's ID starts with "book-". Clicking its link will add the <code>has-target</code> class.</p>
        </section>

        <section id="book-chapter1">
            <h2>Book Chapter 1</h2>
            <p>This section's ID also starts with "book-".</p>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
        </section>

        <section id="other-notes">
            <h2>Other Notes</h2>
            <p>This section's ID is "other-notes". Clicking its link will remove the fade effect.</p>
        </section>

        <section id="book-summary">
            <h2>Book Summary</h2>
            <p>This is the final "book-" section.</p>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainElement = document.querySelector('main');

            // --- Function to check hash and ADD/REMOVE class (from previous example) ---
            function updateTargetState() {
                const hash = window.location.hash;
                let shouldActivateFade = false;

                if (hash && hash.startsWith('#book')) {
                    try {
                        if (document.querySelector(hash)) {
                           shouldActivateFade = true;
                        }
                    } catch (e) {
                         console.warn("Invalid selector:", hash);
                    }
                }

                if (shouldActivateFade) {
                    mainElement.classList.add('has-target');
                } else {
                    mainElement.classList.remove('has-target');
                }
            }

            // Run check on load and hash change
            updateTargetState();
            window.addEventListener('hashchange', updateTargetState);


            // --- NEW: Click listener to REMOVE fade ---
            document.body.addEventListener('click', (event) => {
                // Find the closest anchor link ancestor of the clicked element
                const clickedAnchor = event.target.closest('a');

                // Check if the click was *directly on* or *inside* an anchor link
                // AND if that link's hash starts with #book-
                const isBookLinkClick = clickedAnchor && clickedAnchor.hash && clickedAnchor.hash.startsWith('#book');

                // If the click was NOT on a #book- link, remove the fade effect
                if (!isBookLinkClick) {
                    // Check if the class is currently present before removing
                    if (mainElement.classList.contains('has-target')) {
                        mainElement.classList.remove('has-target');

                        // Optional: Also clear the hash from the URL bar without reloading
                        // This prevents the fade from reappearing on reload if the user clicks away
                        history.pushState("", document.title, window.location.pathname + window.location.search);
                    }
                }
                // If it WAS a click on a #book- link, do nothing here.
                // The 'hashchange' listener will handle adding the class.
            });

        });
    </script>

</body>
</html>